<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Announcements</title>

    <!-- Montserrat Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap"
      rel="stylesheet"
    />

    <!-- Material Icons -->
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined"
      rel="stylesheet"
    />

     <!-- Config.js -->
    <script src="../config.js"></script>

    <!-- External CSS -->
    <link rel="stylesheet" href="../GENERAL/style.css" />
    <style>
      /* Additional styles specific to announcements page */
      .announcements-container {
        padding: 20px;
        /* max-width: 1200px; */
        margin: 0 auto;
      }

      .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
      }

      .page-title {
        font-size: 24px;
        font-weight: 600;
        color: #333;
      }

      .new-announcement-btn {
        background-color: #4caf50;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: background-color 0.3s;
      }

      .new-announcement-btn:hover {
        background-color: #3e8e41;
      }

      /* Table styles */
      .announcements-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        background-color: white;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .announcements-table th {
        background-color: #f5f5f5;
        padding: 12px 15px;
        text-align: left;
        font-weight: 600;
        color: #333;
        border-bottom: 2px solid #ddd;
      }

      .announcements-table td {
        padding: 15px;
        border-bottom: 1px solid #eee;
        vertical-align: top;
      }

      .announcements-table tr:last-child td {
        border-bottom: none;
      }

      .announcements-table tr:hover {
        background-color: #f9f9f9;
      }

      .announcement-number {
        color: #666;
        font-weight: 500;
        width: 50px;
      }

      .announcement-title {
        font-weight: 500;
        color: #333;
      }

      .announcement-date {
        color: #666;
        font-size: 14px;
        white-space: nowrap;
      }

      .announcement-id {
        color: #999;
        font-size: 13px;
      }

      .announcement-message {
        color: #444;
        line-height: 1.5;
        margin-top: 5px;
      }

      .announcement-actions {
        display: flex;
        gap: 5px;
        justify-content: flex-end;
      }

      .action-btn {
        background: none;
        border: none;
        color: #666;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
      }

      .action-btn:hover {
        background-color: #f0f0f0;
      }

      .edit-btn:hover {
        color: #2196f3;
      }

      .delete-btn:hover {
        color: #f44336;
      }

      /* Modal styles */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;
      }

      .modal-overlay.active {
        opacity: 1;
        visibility: visible;
      }

      .modal-content {
        background-color: white;
        padding: 30px;
        border-radius: 8px;
        width: 90%;
        max-width: 600px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        transform: translateY(-20px);
        transition: transform 0.3s;
      }

      .modal-overlay.active .modal-content {
        transform: translateY(0);
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .modal-title {
        font-size: 20px;
        font-weight: 600;
        margin: 0;
      }

      .close-modal {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #666;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #444;
      }

      .form-input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-family: "Montserrat", sans-serif;
      }

      .form-textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        min-height: 120px;
        resize: vertical;
        font-family: "Montserrat", sans-serif;
      }

      .submit-btn {
        background-color: #4caf50;
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 500;
        width: 100%;
        transition: background-color 0.3s;
      }

      .submit-btn:hover {
        background-color: #3e8e41;
      }

      /* Notification styles */
      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background-color: #4caf50;
        color: white;
        padding: 15px 25px;
        border-radius: 5px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        display: flex;
        align-items: center;
        gap: 10px;
        z-index: 1001;
        transform: translateX(120%);
        transition: transform 0.3s;
      }

      .notification.error {
        background-color: #f44336;
      }

      .notification.show {
        transform: translateX(0);
      }

      /* Loading spinner */
      .spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Empty state */
      .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #666;
      }

      /* Responsive adjustments */
      @media (max-width: 768px) {
        .page-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 15px;
        }

        .announcements-table {
          display: block;
          overflow-x: auto;
          white-space: nowrap;
        }

        .announcement-message {
          white-space: normal;
        }

        .modal-content {
          padding: 20px;
        }
      }

      /* Search and recipient selection styles */
      .radio-group {
        display: flex;
        gap: 15px;
        margin-bottom: 15px;
      }

      .radio-group label {
        display: flex;
        align-items: center;
        gap: 5px;
        cursor: pointer;
      }

      .radio-group input[type="radio"] {
        margin: 0;
        cursor: pointer;
      }

      .search-results-container {
        position: absolute;
        width: 100%;
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 10;
        display: none;
        margin-top: 5px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      .search-result-item {
        padding: 10px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
      }

      .search-result-item:hover {
        background-color: #f5f5f5;
      }

      .search-result-item .email {
        font-size: 12px;
        color: #888;
      }

      .selected-recipient-container {
        display: none;
        margin-top: 10px;
      }

      .selected-recipient-container > div {
        background: #f5f5f5;
        padding: 8px 12px;
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .remove-recipient-btn {
        background: none;
        border: none;
        color: #666;
        cursor: pointer;
        padding: 0;
        display: flex;
        align-items: center;
      }

      .remove-recipient-btn:hover {
        color: #f44336;
      }

      /* Loading indicator for search */
      .search-loading {
        padding: 10px;
        text-align: center;
        color: #666;
      }

      /* Error message for search */
      .search-error {
        padding: 10px;
        color: #f44336;
      }

      /* User result specific styles */
      .user-result {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
      }

      .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        background: #f0f0f0;
        flex-shrink: 0;
      }

      .user-info {
        display: flex;
        flex-direction: column;
      }

      .user-name {
        font-weight: bold;
        font-size: 16px;
        color: #222;
      }

      .user-email {
        font-size: 13px;
        color: #888;
        font-weight: 400;
        margin-top: 2px;
      }
    </style>
  </head>
  <body>
    <div class="grid-container" id="containerId">
      <main class="main-container">
        <div class="announcements-container">
          <div class="page-header">
            <h1 class="page-title">Announcements</h1>
            <button class="new-announcement-btn" id="newAnnouncementBtn">
              <span class="material-icons-outlined">add</span>
              New Announcement
            </button>
          </div>

          <div id="announcementsTableContainer">
            <!-- Table will be dynamically inserted here -->
            <div class="empty-state">Loading announcements...</div>
          </div>
        </div>

        <!-- New Announcement Modal -->
        <div class="modal-overlay" id="announcementModal">
          <div class="modal-content">
            <div class="modal-header">
              <h2 class="modal-title" id="modalTitle">
                Create New Announcement
              </h2>
              <button class="close-modal" id="closeModal">&times;</button>
            </div>
            <form id="announcementForm">
              <input type="hidden" id="announcementId" />
              <div class="form-group">
                <label for="announcementTitle" class="form-label">Title</label>
                <input
                  type="text"
                  id="announcementTitle"
                  class="form-input"
                  required
                />
              </div>
              <div class="form-group">
                <label for="announcementMessage" class="form-label"
                  >Message</label
                >
                <textarea
                  id="announcementMessage"
                  class="form-textarea"
                  required
                ></textarea>
              </div>
              <div class="form-group">
                <label class="form-label">Recipient Type</label>
                <div class="radio-group">
                  <label>
                    <input
                      type="radio"
                      name="recipientType"
                      value="entire_parish"
                      checked
                    />
                    Entire Parish
                  </label>
                  <label>
                    <input type="radio" name="recipientType" value="kanda" />
                    Kanda
                  </label>
                  <label>
                    <input
                      type="radio"
                      name="recipientType"
                      value="community"
                    />
                    Community
                  </label>
                  <label>
                    <input
                      type="radio"
                      name="recipientType"
                      value="individual"
                    />
                    Individual
                  </label>
                </div>
              </div>
              <div
                class="form-group"
                id="recipientSearchGroup"
                style="display: none"
              >
                <label
                  for="recipientSearch"
                  class="form-label"
                  id="recipientSearchLabel"
                  >Search Individual</label
                >
                <div style="position: relative">
                  <input
                    type="text"
                    id="recipientSearch"
                    class="form-input"
                    placeholder="Start typing to search..."
                  />
                  <div
                    id="searchResults"
                    class="search-results-container"
                  ></div>
                </div>
                <div
                  id="selectedRecipient"
                  class="selected-recipient-container"
                >
                  <div>
                    <span id="selectedRecipientName"></span>
                    <button id="removeRecipient" class="remove-recipient-btn">
                      <span class="material-icons-outlined">close</span>
                    </button>
                  </div>
                </div>
              </div>
              <button type="submit" class="submit-btn" id="submitBtn">
                <span id="submitBtnText">Send Announcement</span>
                <span
                  class="spinner"
                  id="submitSpinner"
                  style="display: none"
                ></span>
              </button>
            </form>
          </div>
        </div>

        <!-- Confirmation Modal -->
        <div class="modal-overlay" id="confirmModal">
          <div class="modal-content" style="max-width: 400px">
            <div class="modal-header">
              <h2 class="modal-title">Confirm Deletion</h2>
              <button class="close-modal" id="closeConfirmModal">
                &times;
              </button>
            </div>
            <p>
              Are you sure you want to delete this announcement? This action
              cannot be undone.
            </p>
            <div style="display: flex; gap: 10px; margin-top: 20px">
              <button
                class="submit-btn"
                id="cancelDeleteBtn"
                style="background-color: #757575"
              >
                Cancel
              </button>
              <button
                class="submit-btn"
                id="confirmDeleteBtn"
                style="background-color: #f44336"
              >
                Delete
              </button>
            </div>
          </div>
        </div>

        <!-- Notification -->
        <div class="notification" id="notification">
          <span class="material-icons-outlined" id="notificationIcon"
            >check_circle</span
          >
          <span id="notificationMessage">Announcement sent successfully!</span>
        </div>
      </main>
    </div>

    <script src="../GENERAL/script.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // DOM Elements
        const newAnnouncementBtn =
          document.getElementById("newAnnouncementBtn");
        const announcementModal = document.getElementById("announcementModal");
        const confirmModal = document.getElementById("confirmModal");
        const closeModal = document.getElementById("closeModal");
        const closeConfirmModal = document.getElementById("closeConfirmModal");
        const cancelDeleteBtn = document.getElementById("cancelDeleteBtn");
        const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");
        const announcementForm = document.getElementById("announcementForm");
        const tableContainer = document.getElementById(
          "announcementsTableContainer"
        );
        const notification = document.getElementById("notification");
        const notificationIcon = document.getElementById("notificationIcon");
        const notificationMessage = document.getElementById(
          "notificationMessage"
        );
        const modalTitle = document.getElementById("modalTitle");
        const submitBtnText = document.getElementById("submitBtnText");
        const submitSpinner = document.getElementById("submitSpinner");
        const recipientTypeRadios = document.querySelectorAll(
          'input[name="recipientType"]'
        );
        const recipientSearchGroup = document.getElementById(
          "recipientSearchGroup"
        );
        const recipientSearchInput = document.getElementById("recipientSearch");
        const searchResults = document.getElementById("searchResults");
        const selectedRecipient = document.getElementById("selectedRecipient");
        const selectedRecipientName = document.getElementById(
          "selectedRecipientName"
        );
        const removeRecipientBtn = document.getElementById("removeRecipient");
        const recipientSearchLabel = document.getElementById(
          "recipientSearchLabel"
        );

        // State variables
        let currentNotificationId = null;
        let isEditMode = false;
        let selectedRecipientData = null;
        let searchTimeout = null;

        // API Base URL

        // Always get the JWT from localStorage as 'authToken'
        function getAuthToken() {
          return localStorage.getItem("authToken");
        }

        // Helper to add Authorization header
        function authHeaders(extraHeaders = {}) {
          const token = getAuthToken();
          return {
            ...extraHeaders,
            Authorization: token ? `Bearer ${token}` : "",
          };
        }

        // Fetch all announcements
        async function fetchAnnouncements() {
          try {
            // Use the parish notifications endpoint
            const response = await fetch(
              `${BASE_API_URL}/notifications/parish`,
              {
                headers: authHeaders(),
              }
            );
            if (!response.ok) throw new Error("Failed to fetch announcements");
            const announcements = await response.json();
            displayAnnouncements(announcements);
          } catch (error) {
            console.error("Error fetching announcements:", error);
            showNotification("Failed to load announcements", true);
            tableContainer.innerHTML =
              '<div class="empty-state">Failed to load announcements. Please try again later.</div>';
          }
        }

        // Display announcements in a table
        function displayAnnouncements(announcements) {
          if (announcements.length === 0) {
            tableContainer.innerHTML =
              '<div class="empty-state">No announcements found.</div>';
            return;
          }

          const tableHTML = `
                    <table class="announcements-table">
                        <thead>
                            <tr>
                                <th style="width: 50px;">#</th>
                                <th>Announcement</th>
                                <th style="width: 120px;">Date</th>
                                <th style="width: 80px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${announcements
                              .map(
                                (announcement, index) => `
                                <tr>
                                    <td class="announcement-number">${
                                      index + 1
                                    }</td>
                                    <td>
                                        <div class="announcement-title">${
                                          announcement.title
                                        }</div>
                                        <div class="announcement-message">${
                                          announcement.message
                                        }</div>
                                        <div class="announcement-id" style="margin-top: 5px; font-size: 12px; color: #666;">
                                            To: ${formatRecipientInfo(
                                              announcement
                                            )}
                                        </div>
                                    </td>
                                    <td class="announcement-date">${formatDate(
                                      announcement.date
                                    )}</td>
                                    <td>
                                        <div class="announcement-actions">
                                            <button class="action-btn edit-btn" data-id="${
                                              announcement.id
                                            }">
                                                <span class="material-icons-outlined">edit</span>
                                            </button>
                                            <button class="action-btn delete-btn" data-id="${
                                              announcement.id
                                            }">
                                                <span class="material-icons-outlined">delete</span>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `
                              )
                              .join("")}
                        </tbody>
                    </table>
                `;

          tableContainer.innerHTML = tableHTML;

          // Add event listeners to action buttons
          document.querySelectorAll(".edit-btn").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              const id = e.currentTarget.getAttribute("data-id");
              editAnnouncement(id);
            });
          });

          document.querySelectorAll(".delete-btn").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              const id = e.currentTarget.getAttribute("data-id");
              confirmDelete(id);
            });
          });
        }

        // Format recipient information for display
        function formatRecipientInfo(announcement) {
          if (announcement.recipientType === "entire_parish") {
            return "Entire Parish";
          } else if (announcement.recipientType === "community") {
            return announcement.communityName || "Community";
          } else if (announcement.recipientType === "individual") {
            return announcement.recipientName || "Individual";
          } else if (announcement.recipientType === "kanda") {
            return announcement.kandaName || "Kanda";
          }
          return "N/A";
        }

        // Format date to be more readable
        function formatDate(dateString) {
          if (!dateString) return "N/A";
          const date = new Date(dateString);
          if (isNaN(date.getTime())) return "Invalid date";

          return date.toLocaleDateString("en-US", {
            month: "short",
            day: "numeric",
            year: "numeric",
          });
        }

        // Show modal for creating a new announcement
        newAnnouncementBtn.addEventListener("click", () => {
          isEditMode = false;
          modalTitle.textContent = "Create New Announcement";
          document.getElementById("submitBtnText").textContent =
            "Send Announcement";
          document.getElementById("announcementForm").reset();
          document.getElementById("announcementId").value = "";
          selectedRecipientData = null;
          selectedRecipient.style.display = "none";
          recipientSearchGroup.style.display = "none";
          announcementModal.classList.add("active");
        });

        // Close modals
        closeModal.addEventListener("click", () => {
          announcementModal.classList.remove("active");
        });

        closeConfirmModal.addEventListener("click", () => {
          confirmModal.classList.remove("active");
        });

        cancelDeleteBtn.addEventListener("click", () => {
          confirmModal.classList.remove("active");
        });

        // Handle recipient type change
        recipientTypeRadios.forEach((radio) => {
          radio.addEventListener("change", (e) => {
            const type = e.target.value;
            selectedRecipientData = null;
            selectedRecipient.style.display = "none";
            recipientSearchInput.value = "";
            searchResults.style.display = "none";

            if (type === "individual") {
              recipientSearchGroup.style.display = "block";
              recipientSearchLabel.textContent = "Search Individual";
            } else if (type === "community") {
              recipientSearchGroup.style.display = "block";
              recipientSearchLabel.textContent = "Search Community";
            } else if (type === "kanda") {
              recipientSearchGroup.style.display = "block";
              recipientSearchLabel.textContent = "Search Kanda";
            } else {
              recipientSearchGroup.style.display = "none";
            }
          });
        });

        // Handle recipient search
        recipientSearchInput.addEventListener("input", (e) => {
          clearTimeout(searchTimeout);
          const query = e.target.value.trim();

          if (query.length < 2) {
            searchResults.style.display = "none";
            return;
          }

          searchTimeout = setTimeout(() => {
            const recipientType = document.querySelector(
              'input[name="recipientType"]:checked'
            ).value;
            if (recipientType === "individual") {
              searchUsers(query);
            } else if (recipientType === "community") {
              searchCommunities(query);
            } else if (recipientType === "kanda") {
              searchKandas(query);
            }
          }, 300);
        });

        // Replace the searchUsers function with this:
        async function searchUsers(query) {
          try {
            searchResults.innerHTML =
              '<div class="search-loading">Searching...</div>';
            searchResults.style.display = "block";

            const response = await fetch(
              `${BASE_API_URL}/user/search?name=${encodeURIComponent(query)}`,
              {
                headers: authHeaders(),
              }
            );

            if (!response.ok) throw new Error("Search failed");

            const users = await response.json();
            displaySearchResults(users, "user");
          } catch (error) {
            console.error("Search error:", error);
            searchResults.innerHTML =
              '<div class="search-error">Failed to search. Please try again.</div>';
            searchResults.style.display = "block";
          }
        }

        // Add this function for searching kandas
        async function searchKandas(query) {
          try {
            searchResults.innerHTML =
              '<div class="search-loading">Searching...</div>';
            searchResults.style.display = "block";

            const response = await fetch(
              `${BASE_API_URL}/kanda/search?name=${encodeURIComponent(query)}`,
              {
                headers: authHeaders(),
              }
            );

            if (!response.ok) throw new Error("Search failed");

            const kandas = await response.json();
            displaySearchResults(kandas, "kanda");
          } catch (error) {
            console.error("Search error:", error);
            searchResults.innerHTML =
              '<div class="search-error">Failed to search. Please try again.</div>';
            searchResults.style.display = "block";
          }
        }

        // Replace the searchCommunities function with this:
        async function searchCommunities(query) {
          try {
            searchResults.innerHTML =
              '<div class="search-loading">Searching...</div>';
            searchResults.style.display = "block";

            // Use the new endpoint, set description to "community"
            const url = `${BASE_API_URL}/groupsNameByDescription/search?name=${encodeURIComponent(
              query
            )}&description=community`;

            const response = await fetch(url, {
              headers: authHeaders(),
            });

            if (!response.ok) throw new Error("Search failed");

            const communities = await response.json();
            displaySearchResults(communities, "community");
          } catch (error) {
            console.error("Search error:", error);
            searchResults.innerHTML =
              '<div class="search-error">Failed to search. Please try again.</div>';
            searchResults.style.display = "block";
          }
        }

        // Update displaySearchResults to show user profile picture and styled info
        function displaySearchResults(items, type) {
          if (items.length === 0) {
            searchResults.innerHTML =
              '<div style="padding: 10px; color: #666;">No results found</div>';
            searchResults.style.display = "block";
            return;
          }

          const resultsHTML = items
            .map((item) => {
              if (type === "user") {
                // Use a default avatar if no profilePicture is present
                const avatar =
                  item.profilePicture && item.profilePicture.length > 0
                    ? `data:image/jpeg;base64,${item.profilePicture}`
                    : "https://ui-avatars.com/api/?name=" +
                      encodeURIComponent(item.name || "User");
                return `
          <div class="search-result-item user-result" 
               data-id="${item.id}"
               data-name="${item.name}"
               data-type="user">
            <img class="user-avatar" src="${avatar}" alt="Profile" />
            <div class="user-info">
              <div class="user-name">${item.name}</div>
              <div class="user-email">${item.email || ""}</div>
            </div>
          </div>
        `;
              } else if (type === "community") {
                return `
          <div class="search-result-item" 
               data-id="${item.id}"
               data-name="${item.name}"
               data-type="community">
            ${item.name}
            <div class="email">${item.description || "Community"}</div>
          </div>
        `;
              } else if (type === "kanda") {
                return `
          <div class="search-result-item" 
               data-id="${item.id}"
               data-name="${item.name}"
               data-type="kanda">
            ${item.name}
            <div class="email">${item.description || "Kanda"}</div>
          </div>
        `;
              }
            })
            .join("");

          searchResults.innerHTML = resultsHTML;
          searchResults.style.display = "block";

          // Add click handlers to search results
          document.querySelectorAll(".search-result-item").forEach((item) => {
            item.addEventListener("click", (e) => {
              selectedRecipientData = {
                id: item.getAttribute("data-id"),
                name: item.getAttribute("data-name"),
                type: item.getAttribute("data-type"),
              };
              selectedRecipientName.textContent = selectedRecipientData.name;
              selectedRecipient.style.display = "block";
              recipientSearchInput.value = "";
              searchResults.style.display = "none";
            });
          });
        }

        // Handle remove recipient
        removeRecipientBtn.addEventListener("click", () => {
          selectedRecipientData = null;
          selectedRecipient.style.display = "none";
        });

        // Handle form submission for create/update
        announcementForm.addEventListener("submit", async (e) => {
          e.preventDefault();

          const title = document.getElementById("announcementTitle").value;
          const message = document.getElementById("announcementMessage").value;
          const id = document.getElementById("announcementId").value;
          const recipientType = document.querySelector(
            'input[name="recipientType"]:checked'
          ).value;

          // Build Notification object for backend
          const notificationData = {
            title: title,
            message: message,
            date: new Date().toISOString().split("T")[0], // LocalDate format (yyyy-MM-dd)
          };

          if (recipientType === "entire_parish") {
            notificationData.isGlobal = true;
          } else if (recipientType === "individual" && selectedRecipientData) {
            notificationData.userId = selectedRecipientData.id;
            notificationData.isGlobal = false;
          } else if (recipientType === "community" && selectedRecipientData) {
            notificationData.groupId = selectedRecipientData.id;
            notificationData.isGlobal = false;
          } else if (recipientType === "kanda" && selectedRecipientData) {
            notificationData.kandaId = selectedRecipientData.id;
            notificationData.isGlobal = false;
          }

          try {
            toggleSubmitButton(true);
            let response;
            if (isEditMode && id) {
              // Update existing announcement (if you have an update endpoint)
              response = await fetch(`${BASE_API_URL}/notification/${id}`, {
                method: "PUT",
                headers: authHeaders({ "Content-Type": "application/json" }),
                body: JSON.stringify(notificationData),
              });
            } else {
              // Create new announcement
              response = await fetch(`${BASE_API_URL}/notification`, {
                method: "POST",
                headers: authHeaders({ "Content-Type": "application/json" }),
                body: JSON.stringify(notificationData),
              });
            }

            if (!response.ok) {
              throw new Error(
                `Failed to ${isEditMode ? "update" : "create"} announcement`
              );
            }

            const result = await response.json();

            // Refresh the announcements list
            await fetchAnnouncements();

            // Reset form and close modal
            announcementForm.reset();
            announcementModal.classList.remove("active");
            selectedRecipientData = null;
            selectedRecipient.style.display = "none";

            // Show success notification
            showNotification(
              `Announcement ${isEditMode ? "updated" : "created"} successfully!`
            );
          } catch (error) {
            console.error(
              `Error ${isEditMode ? "updating" : "creating"} announcement:`,
              error
            );
            showNotification(
              `Failed to ${isEditMode ? "update" : "create"} announcement`,
              true
            );
          } finally {
            toggleSubmitButton(false);
          }
        });

        // Edit an existing announcement
        async function editAnnouncement(id) {
          try {
            const response = await fetch(`${BASE_API_URL}/notification/${id}`, {
              headers: authHeaders(),
            });
            if (!response.ok) throw new Error("Failed to fetch announcement");
            const announcement = await response.json();

            // Populate the form with the announcement data
            document.getElementById("announcementId").value = announcement.id;
            document.getElementById("announcementTitle").value =
              announcement.title;
            document.getElementById("announcementMessage").value =
              announcement.message;

            // Determine recipient type based on which ID is set
            let recipientType = "entire_parish";
            if (announcement.kandaId) {
              recipientType = "kanda";
            } else if (announcement.groupId) {
              recipientType = "community";
            } else if (announcement.userId) {
              recipientType = "individual";
            } else if (announcement.parishId) {
              recipientType = "entire_parish";
            }

            // Set the radio button
            document.querySelector(
              `input[name="recipientType"][value="${recipientType}"]`
            ).checked = true;

            // Handle recipient data if applicable
            if (recipientType === "individual" && announcement.userId) {
              selectedRecipientData = {
                id: announcement.userId,
                name: announcement.recipientName || "Individual",
                type: "user",
              };
              selectedRecipientName.textContent = selectedRecipientData.name;
              selectedRecipient.style.display = "block";
              recipientSearchGroup.style.display = "block";
              recipientSearchLabel.textContent = "Search Individual";
            } else if (recipientType === "community" && announcement.groupId) {
              selectedRecipientData = {
                id: announcement.groupId,
                name: announcement.communityName || "Community",
                type: "community",
              };
              selectedRecipientName.textContent = selectedRecipientData.name;
              selectedRecipient.style.display = "block";
              recipientSearchGroup.style.display = "block";
              recipientSearchLabel.textContent = "Search Community";
            } else if (recipientType === "kanda" && announcement.kandaId) {
              selectedRecipientData = {
                id: announcement.kandaId,
                name: announcement.kandaName || "Kanda",
                type: "kanda",
              };
              selectedRecipientName.textContent = selectedRecipientData.name;
              selectedRecipient.style.display = "block";
              recipientSearchGroup.style.display = "block";
              recipientSearchLabel.textContent = "Search Kanda";
            } else {
              selectedRecipientData = null;
              selectedRecipient.style.display = "none";
              recipientSearchGroup.style.display = "none";
            }

            // Update UI for edit mode
            isEditMode = true;
            modalTitle.textContent = "Edit Announcement";
            document.getElementById("submitBtnText").textContent =
              "Update Announcement";
            announcementModal.classList.add("active");
          } catch (error) {
            console.error("Error fetching announcement:", error);
            showNotification("Failed to load announcement for editing", true);
          }
        }

        // Confirm deletion of an announcement
        function confirmDelete(id) {
          currentNotificationId = id;
          confirmModal.classList.add("active");
        }

        // Handle delete confirmation
        confirmDeleteBtn.addEventListener("click", async () => {
          if (!currentNotificationId) return;

          try {
            const response = await fetch(
              `${BASE_API_URL}/notification/${currentNotificationId}`,
              {
                method: "DELETE",
                headers: authHeaders(),
              }
            );

            if (!response.ok) {
              throw new Error("Failed to delete announcement");
            }

            // Refresh the announcements list
            await fetchAnnouncements();

            // Close confirmation modal
            confirmModal.classList.remove("active");

            // Show success notification
            showNotification("Announcement deleted successfully!");
          } catch (error) {
            console.error("Error deleting announcement:", error);
            showNotification("Failed to delete announcement", true);
          } finally {
            currentNotificationId = null;
          }
        });

        // Show notification
        function showNotification(message, isError = false) {
          notificationMessage.textContent = message;
          notification.className = isError
            ? "notification error show"
            : "notification show";
          notificationIcon.textContent = isError ? "error" : "check_circle";

          setTimeout(() => {
            notification.className = "notification";
          }, 3000);
        }

        // Toggle submit button loading state
        function toggleSubmitButton(isLoading) {
          if (isLoading) {
            submitBtnText.style.display = "none";
            submitSpinner.style.display = "inline-block";
            document.getElementById("submitBtn").disabled = true;
          } else {
            submitBtnText.style.display = "inline";
            submitSpinner.style.display = "none";
            document.getElementById("submitBtn").disabled = false;
          }
        }

        // Close modal when clicking outside
        announcementModal.addEventListener("click", (e) => {
          if (e.target === announcementModal) {
            announcementModal.classList.remove("active");
          }
        });

        confirmModal.addEventListener("click", (e) => {
          if (e.target === confirmModal) {
            confirmModal.classList.remove("active");
          }
        });

        // Close search results when clicking outside
        document.addEventListener("click", (e) => {
          if (!recipientSearchGroup.contains(e.target)) {
            searchResults.style.display = "none";
          }
        });

        // Initial fetch of announcements
        fetchAnnouncements();
      });
    </script>
  </body>
</html>
