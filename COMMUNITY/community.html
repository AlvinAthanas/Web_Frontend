<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Community Management</title>

  <!-- Fonts and Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet" />

  <!-- Styles -->
  <link rel="stylesheet" href="../GENERAL/style.css" />
  <link rel="stylesheet" href="community.css" />
</head>

<body>
  <div class="grid-container" id="containerId">
    <main class="main-container">
      <div class="container">
        <h2>Community List</h2>
        <input type="text" id="communityInput" placeholder="Enter community name" required>
        <button class="add-btn" onclick="addCommunity()">Add</button>
        <ul class="community-list" id="communityList"></ul>
      </div>
    </main>
  </div>

  <script>
    const apiUrl = "http://localhost:8080"; // adjust if needed

    // Fetch and display all communities
    async function fetchCommunities() {
      try {
        const response = await fetch(`${apiUrl}/groups/communities`);
        const communities = await response.json();
        renderCommunityList(communities);
      } catch (error) {
        console.error("Error fetching communities:", error);
      }
    }

    // Render list items
    function renderCommunityList(communities) {
      const list = document.getElementById("communityList");
      list.innerHTML = "";

      communities.forEach((community) => {
        const li = document.createElement("li");
        const link = document.createElement("a");
        link.href = `trial.html?communityId=${community.id}`;
        link.textContent = community.name;

        const delButton = document.createElement("button");
        delButton.textContent = "Delete";
        delButton.classList.add("delete-btn");
        delButton.onclick = () => deleteCommunity(community.id, li);

        const editButton = document.createElement("button");
        editButton.textContent = "Edit";
        editButton.classList.add("edit-btn");
        editButton.onclick = () => enableEditing(li, link, community.id);

        li.appendChild(link);
        li.appendChild(editButton);
        li.appendChild(delButton);
        list.appendChild(li);
      });
    }

    // Add new community
    async function addCommunity() {
      const input = document.getElementById("communityInput");
      const name = input.value.trim();
      if (!name) return;

      try {
        const response = await fetch(`${apiUrl}/group/community`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name })
        });

        if (!response.ok) throw new Error("Failed to add community");

        input.value = "";
        fetchCommunities();
      } catch (error) {
        console.error("Error adding community:", error);
      }
    }

    // Delete community (optional backend call if you have delete support)
    async function deleteCommunity(id, li) {
      if (!confirm("Delete this community?")) return;
      try {
        const response = await fetch(`${apiUrl}/group/${id}`, {
          method: "DELETE",
        });

        if (!response.ok) throw new Error("Failed to delete community");

        li.remove();
      } catch (error) {
        console.error("Error deleting community:", error);
      }
    }

    // Edit community name
    function enableEditing(li, link, id) {
      const input = document.createElement("input");
      input.type = "text";
      input.value = link.textContent;
      input.classList.add("edit-input");

      const saveBtn = document.createElement("button");
      saveBtn.textContent = "Save";
      saveBtn.classList.add("save-btn");

      const cancelBtn = document.createElement("button");
      cancelBtn.textContent = "Cancel";
      cancelBtn.classList.add("cancel-btn");

      const originalName = link.textContent;

      li.replaceChild(input, link);
      li.replaceChild(saveBtn, li.children[1]); // edit button
      li.appendChild(cancelBtn);
      li.children[2].style.display = "none"; // hide delete

      saveBtn.onclick = async () => {
        const newName = input.value.trim();
        if (newName === "") return;

        try {
          const response = await fetch(`${apiUrl}/group/${id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id, name: newName, description: "community" })
          });

          if (!response.ok) throw new Error("Failed to update");

          link.textContent = newName;
          reset();
        } catch (error) {
          console.error("Update error:", error);
        }
      };

      cancelBtn.onclick = reset;

      function reset() {
        li.replaceChild(link, input);
        li.replaceChild(createEditButton(link, id), saveBtn);
        li.removeChild(cancelBtn);
        li.children[2].style.display = "inline-block";
      }

      function createEditButton(link, id) {
        const button = document.createElement("button");
        button.textContent = "Edit";
        button.classList.add("edit-btn");
        button.onclick = () => enableEditing(li, link, id);
        return button;
      }

      input.focus();
    }

    // Initial load
    fetchCommunities();
  </script>

  <script src="../GENERAL/script.js"></script>
</body>

</html>
