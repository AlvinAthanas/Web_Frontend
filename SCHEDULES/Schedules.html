<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Schedules</title>

    <link rel="stylesheet" href="../SCHEDULES/Schedules.css" />
    <link rel="stylesheet" href="../GENERAL/style.css" />
  </head>
  <body>
    <div class="grid-container" id="containerId">
      <main class="main-container">
        <div class="divider"><span>Enter Mass Schedule</span></div>
        <form id="scheduleForm">
          <input
            type="text"
            id="name"
            name="name"
            placeholder="Mass Name"
            required
          />
          <input type="time" id="dateTime" name="dateTime" required />
          <button type="submit">Add Schedule</button>
        </form>

        <table id="tableBody">
          <thead>
            <tr>
              <th>#</th>
              <th>Mass Name</th>
              <th>Time</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="scheduleTableBody"></tbody>
        </table>
      </main>
    </div>
    <div id="response"></div>

    <script>
      const formEl = document.getElementById("scheduleForm");
      const responseBox = document.getElementById("response");
      const tableBody = document.getElementById("tableBody");
      const submitBtn = formEl.querySelector("button[type='submit']");

      let editingId = null;

      //  Loading and displaying Schedules
      function loadSchedules() {
        fetch("http://localhost:8080/events")
          .then((res) => res.json())
          .then((data) => {
            tableBody.innerHTML = "";

            data.forEach((schedule, index) => {
              const row = document.createElement("tr");
              row.innerHTML = `
  <td>${index + 1}</td>
  <td>${schedule.name}</td>
  <td>${schedule.dateTime}</td>
  <td>
 <button class="edit-btn" onclick="editSchedule(${schedule.id}, '${
                schedule.name
              }', '${schedule.dateTime}')">Edit</button>
<button class="delete-btn" onclick="deleteSchedule(${
                schedule.id
              })">Delete</button>    </td>

  `;
              tableBody.appendChild(row);
            });
          })
          .catch((err) => {
            responseBox.innerHTML = "Failed to load schedule " + err.message;
          });
      }

      // Creating a new Schedule
      function handleCreate(schedule) {
        schedule.preventDefault();

        const name = formEl.name.value;
        const dateTime = formEl.dateTime.value;

        const data = { name, dateTime };

        fetch("http://localhost:8080/event", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        })
          .then((res) => res.json())
          .then(() => {
            responseBox.innerText = "Schedule has been added successfully!";
            formEl.reset();
            formDialog.style.display = "none";
            loadSchedules();
          })
          .catch((error) => {
            responseBox.innerText = "Failed to add schedule: " + error.message;
          });
      }

      // Updating an Existing Schedule
      function handleUpdate(schedule) {
        schedule.preventDefault();

        const name = formEl.name.value;
        const dateTime = formEl.dateTime.value;

        const data = { name, dateTime };

        fetch(`http://localhost:8080/schedule/${editingId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        })
          .then((res) => {
            if (!res.ok) throw new Error("Update failed");
            return res.json();
          })
          .then(() => {
            responseBox.innerText = "Schedule updated successfully!";
            formEl.reset();
            formDialog.style.display = "none";
            editingId = null;
            submitBtn.innerText = "Add Schedule";
            loadSchedules();
          })
          .catch((error) => {
            responseBox.innerText = "Failed to update: " + error.message;
          });
      }

      // Deleting a Shedule
      function deleteSchedule(id) {
        const confirmed = confirm(
          "Are you sure you want to delete this event?"
        );
        if (!confirmed) return;

        fetch(`http://localhost:8080/event/${id}`, {
          method: "DELETE",
        })
          .then((res) => {
            if (res.ok) {
              loadSchedules();
            } else {
              throw new Error("Delete failed");
            }
          })
          .catch((error) => {
            console.error("Failed to delete:", error);
            responseBox.innerText = "Failed to delete: " + error.message;
          });
      }

      // Editing a Schedule
      function editSchedule(id) {
        fetch(`http://localhost:8080/events/${id}`)
          .then((res) => res.json())
          .then((data) => {
            editingId = id;
            formEl.name.value = data.name;
            formEl.dateTime.value = data.dateTime;
            submitBtn.innerText = "Update Schedule";
          })
          .catch((err) => {
            console.error("Error loading for edit:", err);
            responseBox.innerText = "Failed to load schedule: " + err.message;
          });
      }

      // Handle form submit (create or update)
      formEl.addEventListener("submit", (e) => {
        if (editingId === null) {
          handleCreate(e);
        } else {
          handleUpdate(e);
        }
      });

      window.addEventListener("DOMContentLoaded", loadSchedules);
    </script>

    <script src="../GENERAL/script.js"></script>
  </body>
</html>
