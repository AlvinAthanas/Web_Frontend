<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Schedules</title>

    <link rel="stylesheet" href="../SCHEDULES/Schedules.css" />
    <link rel="stylesheet" href="../GENERAL/style.css" />
  </head>
  <body>
    <div class="grid-container" id="containerId">
      <main class="main-container">
        <div class="divider"><span>Enter Mass Schedule</span></div>
        <form id="scheduleForm">
          <input type="text" id="name" name="name" placeholder="Mass Name" required />
          <input type="time" id="dateTime" name="dateTime" required />
          <button type="submit">Add Schedule</button>
        </form>

        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Mass Name</th>
              <th>Time</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="scheduleTableBody"></tbody>
        </table>
      </main>
    </div>

    <script>
      const apiUrl = "http://localhost:8080"; // change if needed
      const form = document.getElementById("scheduleForm");
      const nameInput = document.getElementById("name");
      const timeInput = document.getElementById("dateTime");
      const tableBody = document.getElementById("scheduleTableBody");

      let editingId = null;

      // Fetch and display all schedules
      async function fetchSchedules() {
        try {
          const response = await fetch(`${apiUrl}/events`);
          const schedules = await response.json();
          renderTable(schedules);
        } catch (error) {
          console.error("Failed to fetch schedules:", error);
        }
      }

      // Render table
      function renderTable(schedules) {
        tableBody.innerHTML = "";
        schedules.forEach((schedule, index) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${index + 1}</td>
            <td>${schedule.name}</td>
            <td>${schedule.dateTime}</td>
            <td>
              <button class="edit-btn" onclick="editSchedule(${schedule.id}, '${
            schedule.name
          }', '${schedule.dateTime}')">Edit</button>
              <button class="delete-btn" onclick="deleteSchedule(${
                schedule.id
              })">Delete</button>
            </td>
          `;
          tableBody.appendChild(row);
        });
      }

      // Handle form submission (add or update)
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const name = nameInput.value.trim();
        const time = timeInput.value;

        if (!name || !time) return;

        const scheduleData = { name, time };

        try {
          if (editingId) {
            // PUT request to update
            const response = await fetch(`${apiUrl}/event/${editingId}`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(scheduleData),
            });

            if (!response.ok) throw new Error("Failed to update schedule");

            editingId = null;
            form.querySelector("button").textContent = "Add Schedule";
          } else {
            // POST request to add
            const response = await fetch(`${apiUrl}/event`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(scheduleData),
            });

            if (!response.ok) throw new Error("Failed to add schedule");
          }

          form.reset();
          fetchSchedules();
        } catch (error) {
          console.error("Submit error:", error);
        }
      });

      // Prepare form for editing
      function editSchedule(id, name, time) {
        nameInput.value = name;
        timeInput.value = e.dateTime;
        editingId = id;
        form.querySelector("button").textContent = "Update Schedule";
      }

      // Delete with confirmation
      async function deleteSchedule(id) {
        if (confirm("Are you sure you want to delete this schedule?")) {
          try {
            const response = await fetch(`${apiUrl}/event/${id}`, {
              method: "DELETE",
            });

            if (!response.ok) throw new Error("Failed to delete schedule");
            fetchSchedules();
          } catch (error) {
            console.error("Delete error:", error);
          }
        }
      }

      // Initial fetch
      fetchSchedules();
    </script>

    <script src="../GENERAL/script.js"></script>
  </body>
</html>
