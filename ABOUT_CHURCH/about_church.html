<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Church Profile | Management</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Icons -->
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Custom Styles -->
    <link rel="stylesheet" href="../GENERAL/style.css" />
    <style>
      body {
        font-family: "Poppins", sans-serif;
        background-color: #f4f6f9;
        margin: 0;
        padding: 0;
      }

      .form-group {
        margin-bottom: 1.5rem;
      }
      .form-group label {
        display: block;
        font-weight: 500;
        margin-bottom: 0.5rem;
        color: #333;
      }
      .form-group input,
      .form-group textarea {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        font-size: 1rem;
        transition: border-color 0.3s;
      }
      .form-group input:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #2563eb;
      }
      .form-group textarea {
        resize: vertical;
        min-height: 100px;
      }
      .image-preview {
        max-width: 100%;
        height: auto;
        margin-top: 1rem;
        border-radius: 0.375rem;
      }
      .section-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 1rem;
        border-bottom: 2px solid #e5e7eb;
        padding-bottom: 0.5rem;
      }
      .empty-state {
        text-align: center;
        padding: 4rem 0;
      }
      .view-mode img {
        max-width: 100%;
        height: auto;
        border-radius: 0.5rem;
        margin-bottom: 2rem;
      }
      .view-mode .detail-item {
        margin-bottom: 1rem;
      }
      .view-mode .detail-item span {
        font-weight: 500;
        color: #1f2937;
      }
      #viewMode .section-title {
        font-size: 1.15rem;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 0.5rem;
        border-bottom: 1px solid #e5e7eb;
        padding-bottom: 0.25rem;
      }
      #viewMode span.font-semibold {
        min-width: 120px;
        display: inline-block;
      }
      @media (max-width: 640px) {
        .main-container {
          padding: 1rem;
        }
        .form-group input,
        .form-group textarea {
          font-size: 0.875rem;
        }
        .section-title {
          font-size: 1.125rem;
        }
      }
      @media (max-width: 768px) {
        #viewMode .flex-col.md\:flex-row {
          flex-direction: column !important;
        }
        #viewMode .grid-cols-2 {
          grid-template-columns: 1fr !important;
        }
      }
    </style>
  </head>
  <body>
    <div class="grid-container" id="containerId">
      <main class="main-container">
        <!-- Empty State -->
        <div id="emptyState" class="empty-state">
          <h2 class="text-xl font-semibold text-gray-600 mb-4">
            No Church Details Available
          </h2>
          <button
            id="addDetailsBtn"
            class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 transition flex items-center mx-auto"
          >
            <span class="material-icons mr-2">add</span> Add Details
          </button>
        </div>

        <!-- Edit Mode (Form) -->
        <div id="editMode" class="bg-white p-6 rounded-lg shadow-md hidden">
          <h1
            class="text-2xl font-semibold mb-6 text-gray-800 flex items-center"
          >
            <span class="material-icons mr-2">church</span> Church Profile
          </h1>
          <form id="churchProfileForm" class="space-y-6">
            <!-- Church Details Section -->
            <div>
              <h2 class="section-title flex items-center">
                <span class="material-icons mr-2">info</span> Church Details
              </h2>
              <div class="form-group">
                <label for="churchName">Church Name</label>
                <input
                  type="text"
                  id="churchName"
                  name="churchName"
                  placeholder="Enter church name"
                  class="w-full"
                />
              </div>
              <div class="form-group">
                <label for="churchHistory">Church History</label>
                <textarea
                  id="churchHistory"
                  name="churchHistory"
                  placeholder="Enter the history of the church..."
                  class="w-full"
                ></textarea>
              </div>
            </div>

            <!-- Contacts Section -->
            <div>
              <h2 class="section-title flex items-center">
                <span class="material-icons mr-2">phone</span> Contacts
              </h2>
              <div class="form-group">
                <label for="phoneNumber">Phone Number</label>
                <input
                  type="tel"
                  id="phoneNumber"
                  name="phoneNumber"
                  placeholder="Enter phone number"
                  class="w-full"
                />
              </div>
              <div class="form-group">
                <label for="email">Email</label>
                <input
                  type="email"
                  id="email"
                  name="email"
                  placeholder="Enter email address"
                  class="w-full"
                />
              </div>
            </div>

            <!-- Address Section -->
            <div>
              <h2 class="section-title flex items-center">
                <span class="material-icons mr-2">location_on</span> Address
              </h2>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="form-group">
                  <label for="poBox">P.O. Box</label>
                  <input
                    type="text"
                    id="poBox"
                    name="poBox"
                    placeholder="Enter P.O. Box"
                    class="w-full"
                  />
                </div>
                <div class="form-group">
                  <label for="street">Street</label>
                  <input
                    type="text"
                    id="street"
                    name="street"
                    placeholder="Enter street address"
                    class="w-full"
                  />
                </div>
                <div class="form-group">
                  <label for="city">City</label>
                  <input
                    type="text"
                    id="city"
                    name="city"
                    placeholder="Enter city"
                    class="w-full"
                  />
                </div>
                <div class="form-group">
                  <label for="region">Region</label>
                  <input
                    type="text"
                    id="region"
                    name="region"
                    placeholder="Enter region"
                    class="w-full"
                  />
                </div>
              </div>
            </div>

            <!-- Social Media Section -->
            <div>
              <h2 class="section-title flex items-center">
                <span class="material-icons mr-2">share</span> Social Media
              </h2>
              <div class="space-y-4">
                <div class="flex items-center gap-2">
                  <span class="material-icons text-blue-600">facebook</span>
                  <input
                    type="url"
                    id="facebook"
                    name="facebook"
                    placeholder="Facebook URL"
                    class="flex-1"
                  />
                </div>
                <div class="flex items-center gap-2">
                  <span class="material-icons text-blue-400"
                    >alternate_email</span
                  >
                  <input
                    type="url"
                    id="twitter"
                    name="twitter"
                    placeholder="Twitter/X URL"
                    class="flex-1"
                  />
                </div>
                <div class="flex items-center gap-2">
                  <span class="material-icons text-pink-500">photo_camera</span>
                  <input
                    type="url"
                    id="instagram"
                    name="instagram"
                    placeholder="Instagram URL"
                    class="flex-1"
                  />
                </div>
              </div>
            </div>

            <!-- Church Image -->
            <div class="form-group">
              <label for="churchImage">Church Image</label>
              <input
                type="file"
                id="churchImage"
                name="churchImage"
                accept="image/*"
                class="w-full"
              />
              <img
                id="imagePreview"
                class="image-preview"
                alt="Church Image Preview"
                style="display: none"
              />
            </div>

            <!-- Save Button -->
            <div class="flex justify-end">
              <button
                type="submit"
                class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 transition flex items-center"
              >
                <span class="material-icons mr-2">save</span> Save Profile
              </button>
            </div>
          </form>
        </div>

        <!-- View Mode -->
        <div id="viewMode" class="bg-white p-8 rounded-xl shadow-lg hidden">
          <div class="flex flex-col md:flex-row gap-8 items-start">
            <img
              id="viewImage"
              class="w-full md:w-1/3 max-w-xs rounded-lg shadow-md border border-gray-200"
              alt="Church Image"
            />
            <div class="flex-1 space-y-8">
              <!-- Church Details -->
              <div>
                <h2 class="section-title flex items-center mb-4">
                  <span class="material-icons mr-2">info</span> Church Details
                </h2>
                <div class="mb-2">
                  <span class="font-semibold text-gray-700 block"
                    >Church Name:</span
                  >
                  <span id="viewChurchName" class="text-gray-900"></span>
                </div>
                <div class="mb-2">
                  <span class="font-semibold text-gray-700 block"
                    >Parish Priest:</span
                  >
                  <span id="viewParishPriest" class="text-gray-900"></span>
                </div>
                <div>
                  <span class="font-semibold text-gray-700 block"
                    >History:</span
                  >
                  <span id="viewChurchHistory" class="text-gray-900"></span>
                </div>
              </div>
              <!-- Contacts and Address -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                  <h2 class="section-title flex items-center mb-4">
                    <span class="material-icons mr-2">phone</span> Contacts
                  </h2>
                  <div class="mb-2">
                    <span class="font-semibold text-gray-700 block"
                      >Phone Number:</span
                    >
                    <span id="viewPhoneNumber" class="text-gray-900"></span>
                  </div>
                  <div>
                    <span class="font-semibold text-gray-700 block"
                      >Email:</span
                    >
                    <span id="viewEmail" class="text-gray-900"></span>
                  </div>
                </div>
                <div>
                  <h2 class="section-title flex items-center mb-4">
                    <span class="material-icons mr-2">location_on</span> Address
                  </h2>
                  <div class="mb-2">
                    <span class="font-semibold text-gray-700 block"
                      >P.O. Box:</span
                    >
                    <span id="viewPoBox" class="text-gray-900"></span>
                  </div>
                  <div class="mb-2">
                    <span class="font-semibold text-gray-700 block"
                      >Street:</span
                    >
                    <span id="viewStreet" class="text-gray-900"></span>
                  </div>
                  <div class="mb-2">
                    <span class="font-semibold text-gray-700 block">City:</span>
                    <span id="viewCity" class="text-gray-900"></span>
                  </div>
                  <div>
                    <span class="font-semibold text-gray-700 block"
                      >Region:</span
                    >
                    <span id="viewRegion" class="text-gray-900"></span>
                  </div>
                </div>
              </div>
              <!-- Social Media -->
              <div>
                <h2 class="section-title flex items-center mb-4">
                  <span class="material-icons mr-2">share</span> Social Media
                </h2>
                <div
                  class="social-media-links"
                  style="display: flex; gap: 24px; margin-top: 16px"
                >
                  <a
                    id="viewFacebook"
                    href="#"
                    target="_blank"
                    style="
                      text-align: center;
                      color: #4267b2;
                      text-decoration: none;
                    "
                  >
                    <span class="material-icons" style="font-size: 36px"
                      >facebook</span
                    >
                    <div style="font-size: 12px">Facebook</div>
                  </a>
                  <a
                    id="viewTwitter"
                    href="#"
                    target="_blank"
                    style="
                      text-align: center;
                      color: #1da1f2;
                      text-decoration: none;
                    "
                  >
                    <span class="material-icons" style="font-size: 36px"
                      >twitter</span
                    >
                    <div style="font-size: 12px">Twitter</div>
                  </a>
                  <a
                    id="viewInstagram"
                    href="#"
                    target="_blank"
                    style="
                      text-align: center;
                      color: #c13584;
                      text-decoration: none;
                    "
                  >
                    <span class="material-icons" style="font-size: 36px"
                      >instagram</span
                    >
                    <div style="font-size: 12px">Instagram</div>
                  </a>
                </div>
              </div>
              <!-- Edit Button -->
              <div class="flex justify-end pt-4">
                <button
                  id="editDetailsBtn"
                  class="bg-gray-600 text-white px-6 py-2 rounded-md hover:bg-gray-700 transition flex items-center"
                >
                  <span class="material-icons mr-2">edit</span> Edit Details
                </button>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- JavaScript for State Management, Image Preview, and Form Submission -->
    <script src="../GENERAL/script.js"></script>
    <script>
      // State Management
      const emptyState = document.getElementById("emptyState");
      const editMode = document.getElementById("editMode");
      const viewMode = document.getElementById("viewMode");
      const addDetailsBtn = document.getElementById("addDetailsBtn");
      const editDetailsBtn = document.getElementById("editDetailsBtn");
      const churchProfileForm = document.getElementById("churchProfileForm");
      const churchImageInput = document.getElementById("churchImage");
      const imagePreview = document.getElementById("imagePreview");

      let churchData = null;

      // Show Edit Mode
      function showEditMode() {
        emptyState.classList.add("hidden");
        editMode.classList.remove("hidden");
        viewMode.classList.add("hidden");
      }

      // Show View Mode
      function showViewMode(data) {
        emptyState.classList.add("hidden");
        editMode.classList.add("hidden");
        viewMode.classList.remove("hidden");

        document.getElementById("viewImage").src = data.imageUrl || "";
        document.getElementById("viewChurchName").textContent =
          data.name || "N/A";
        document.getElementById("viewParishPriest").textContent =
          data.parishPriest || "N/A";
        document.getElementById("viewChurchHistory").textContent =
          data.history || "N/A";
        document.getElementById("viewPhoneNumber").textContent =
          data.parishPhoneNumber || "N/A";
        document.getElementById("viewEmail").textContent = data.email || "N/A";
        document.getElementById("viewPoBox").textContent = data.poBox || "N/A";
        document.getElementById("viewStreet").textContent =
          data.street || "N/A";
        document.getElementById("viewCity").textContent = data.city || "N/A";
        document.getElementById("viewRegion").textContent =
          data.region || "N/A";
        document.getElementById("viewLocation").textContent =
          data.location || "N/A";
        document.getElementById("viewContactInfo").textContent =
          data.contactInfo || "N/A";

        // Facebook
        const facebookLink = document.getElementById("viewFacebook");
        if (data.facebookLink) {
          facebookLink.href = data.facebookLink;
          facebookLink.style.display = "";
        } else {
          facebookLink.style.display = "none";
        }

        // Twitter
        const twitterLink = document.getElementById("viewTwitter");
        if (data.twitterLink) {
          twitterLink.href = data.twitterLink;
          twitterLink.style.display = "";
        } else {
          twitterLink.style.display = "none";
        }

        // Instagram
        const instagramLink = document.getElementById("viewInstagram");
        if (data.instagramLink) {
          instagramLink.href = data.instagramLink;
          instagramLink.style.display = "";
        } else {
          instagramLink.style.display = "none";
        }
      }

      // Populate form with parish data
      function populateForm(data) {
        const fields = [
          ["churchName", data.name],
          ["parishPriest", data.parishPriest],
          ["location", data.location],
          ["contactInfo", data.contactInfo],
          ["churchHistory", data.history],
          ["phoneNumber", data.parishPhoneNumber],
          ["email", data.email],
          ["poBox", data.poBox],
          ["street", data.street],
          ["city", data.city],
          ["region", data.region],
          ["facebook", data.facebookLink],
          ["twitter", data.twitterLink],
          ["instagram", data.instagramLink],
        ];
        fields.forEach(([id, value]) => {
          const el = document.getElementById(id);
          if (el) {
            el.value = value || "";
          } else {
            console.warn(`Element with id "${id}" not found`);
          }
        });
        if (data.imageUrl && typeof imagePreview !== "undefined") {
          imagePreview.src = data.imageUrl;
          imagePreview.style.display = "block";
        }
      }

      // Add Details Button
      addDetailsBtn.addEventListener("click", showEditMode);

      // Edit Details Button
      editDetailsBtn.addEventListener("click", () => {
        showEditMode();
        if (churchData) {
          populateForm(churchData);
        }
      });

      // Image Preview
      churchImageInput.addEventListener("change", function () {
        const file = this.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function (e) {
            imagePreview.src = e.target.result;
            imagePreview.style.display = "block";
          };
          reader.readAsDataURL(file);
        } else {
          imagePreview.style.display = "none";
        }
      });

      // Helper to get JWT from localStorage
      function getAuthToken() {
        return localStorage.getItem("authToken");
      }

      // Fetch parish info
      async function loadParishFromServer(parishId) {
        try {
          const response = await fetch(
            `http://localhost:8080/parish/${parishId}`,
            {
              headers: {
                Authorization: "Bearer " + getAuthToken(),
              },
            }
          );
          if (!response.ok) throw new Error("Failed to load parish");
          return await response.json();
        } catch (error) {
          return null;
        }
      }

      // Update parish info
      async function saveParishToServer(parishId, data) {
        try {
          const response = await fetch(
            `http://localhost:8080/parish/${parishId}`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: "Bearer " + getAuthToken(),
              },
              body: JSON.stringify(data),
            }
          );
          if (!response.ok) throw new Error("Failed to save parish");
          return await response.json();
        } catch (error) {
          alert("Error saving parish: " + error.message);
          throw error;
        }
      }

      // Fictitious fetch functions for server communication
      async function saveChurchProfileToServer(data) {
        // Simulate a POST request to your backend
        // Replace the URL and logic as needed
        try {
          const response = await fetch(
            "http://localhost:8080/api/church-profile",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data),
            }
          );
          if (!response.ok) throw new Error("Failed to save profile");
          return await response.json();
        } catch (error) {
          alert("Error saving profile: " + error.message);
          throw error;
        }
      }

      async function loadChurchProfileFromServer() {
        // Simulate a GET request to your backend
        // Replace the URL and logic as needed
        try {
          const response = await fetch(
            "http://localhost:8080/api/church-profile"
          );
          if (!response.ok) throw new Error("Failed to load profile");
          return await response.json();
        } catch (error) {
          // If not found, return null
          return null;
        }
      }

      // Replace with your actual parish ID logic
      const parishId = localStorage.getItem("parishId") || 1;

      document.addEventListener("DOMContentLoaded", async function () {
        const data = await loadParishFromServer(parishId);
        if (data) {
          churchData = data;
          showViewMode(data);
        } else {
          emptyState.classList.remove("hidden");
          editMode.classList.add("hidden");
          viewMode.classList.add("hidden");
        }
      });

      // Form Submission
      churchProfileForm.addEventListener("submit", function (e) {
        e.preventDefault();
        const formData = new FormData(this);
        const data = Object.fromEntries(formData);

        // Map form fields to parish fields
        const parishUpdate = {
          name: data.churchName,
          history: data.churchHistory,
          phoneNumber: data.phoneNumber,
          email: data.email,
          poBox: data.poBox,
          street: data.street,
          city: data.city,
          region: data.region,
          facebook: data.facebook,
          twitter: data.twitter,
          instagram: data.instagram,
          image: churchData && churchData.image, // default to existing image
        };

        function finalizeAndSave(imageData) {
          parishUpdate.image = imageData;
          saveParishToServer(parishId, parishUpdate)
            .then((savedData) => {
              churchData = savedData;
              showViewMode(savedData);
              alert("Profile saved successfully!");
              churchProfileForm.reset();
              imagePreview.style.display = "none";
            })
            .catch(() => {});
        }

        if (churchImageInput.files[0]) {
          const reader = new FileReader();
          reader.onload = function (e) {
            finalizeAndSave(e.target.result);
          };
          reader.readAsDataURL(churchImageInput.files[0]);
        } else {
          finalizeAndSave(churchData ? churchData.image : "");
        }
      });
    </script>
  </body>
</html>
