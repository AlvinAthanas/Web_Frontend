<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>

    <!-- Montserrat Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap"
      rel="stylesheet"
    />

    <!-- Material Icons -->
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined"
      rel="stylesheet"
    />

  <!-- Base API URL -->
    <script src="../config.js"></script>

  </head>
  <body>
    <!-- <div class="grid-container"> -->
    <!-- Header -->
    <header class="header">
      <div class="menu-icon" onclick="openSidebar()">
        <span class="material-icons-outlined"> menu </span>
      </div>
      <div class="header-left">
        <span class="material-icons-outlined"> search </span>
      </div>

      <div class="header-right">
        <!-- <span class="material-icons-outlined"> notifications </span>
        <span class="material-icons-outlined"> mail </span> -->
        <div class="account-container" id="accountContainer" style="display: flex; align-items: center; gap: 10px;">
          <span id="profileAvatar" class="material-icons-outlined" style="font-size: 2rem; background: #e3e6ea; border-radius: 50%; width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; color: #607d8b;"></span>
          <span id="userName" style="font-weight: 500; color: #2c3e50;"></span>
          <div class="account-dropdown">
            <a href="../PROFILE/profile.html" class="dropdown-item">
              <span class="material-icons-outlined">person</span>
              Profile
            </a>
            <div class="dropdown-divider"></div>
            <a href="../index.html" class="dropdown-item">
              <span class="material-icons-outlined">logout</span>
              Logout
            </a>
          </div>
        </div>
      </div>
    </header>
    <!-- End Header -->

    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar">
      <div class="sidebar-title">
        <div class="sidebar-brand">
          <span class="material-icons-outlined"></span>
          <span id="parish-name">MENU</span>
        </div>
        <span class="material-icons-outlined" onclick="closeSidebar()"
          >close</span
        >
      </div>
      <ul class="sidebar-list">
        <a href="../DASHBOARD/dashboard.html">
          <li class="sidebar-list-item">
            <span class="material-icons-outlined">dashboard</span>
            Dashboard
          </li>
        </a>

         <a href="../DASHBOARD/Treasurer_dashboard.html">
          <li class="sidebar-list-item">
            <span class="material-icons-outlined">dashboard</span>
           Dashboard
          </li>
        </a>


         <a href="../ABOUT_CHURCH/about_church.html">
          <li class="sidebar-list-item">
            <span class="material-icons-outlined">info</span> About Church
          </li>
        </a>

        <a href="../ROLES/roles.html">
          <li class="sidebar-list-item">
            <span class="material-icons-outlined">assignment_ind</span> Roles
          </li>
        </a>

        <a href="../MEMBERS/members.html">
          <li class="sidebar-list-item">
            <span class="material-icons-outlined">people</span> Members
          </li>
        </a>

        <a href="../CONTRIBUTION/contribution.html">
          <li class="sidebar-list-item">
            <span class="material-icons-outlined"> payments </span>
            Contribution
          </li>
        </a>

         <a href="../EXPENSES/expenses.html">
           <li class="sidebar-list-item">
             <span class="material-icons-outlined"> money_off </span>
             Expenses
           </li>
         </a>

        <a href="../SCHEDULES/Schedules.html">
          <li class="sidebar-list-item">
            <span class="material-icons-outlined">calendar_month</span>
            Schedule
          </li>
        </a>

        <a href="../EVENTS/Events.html">
          <li class="sidebar-list-item">
            <span class="material-icons-outlined"> event </span>
            Events
          </li>
        </a>

        <a href="../NEW COMMUNITY/community.html">
          <li class="sidebar-list-item">
            <span class="material-icons-outlined"> groups </span>
            Community
          </li>
        </a>

        
        <a href="../NEW COMMUNITY/trial.html">
          <li class="sidebar-list-item">
            <span class="material-icons-outlined"> groups </span>
            Community
          </li>
        </a>


        <a href="../PROJECTS/projects.html">
          <li class="sidebar-list-item">
            <span class="material-icons-outlined"> rowing </span>
            Projects
          </li>
        </a>

        <a href="../SACRAMENTS/sacraments.html">
          <li class="sidebar-list-item">
            <span class="material-icons-outlined"> flare </span>
             Sacraments
          </li>
        </a>

        <a href="../ANNOUNCEMENTS/announcement.html">
          <li class="sidebar-list-item">
            <span class="material-icons-outlined"> campaign </span>
             Announcements
          </li>
        </a>
        
        <a href="../REPORTS/reports.html">
          <li class="sidebar-list-item">
            <span class="material-icons-outlined"> library_books </span>
            Reports
          </li>
        </a>

         <a href="../FEEDBACK/feedback.html">
          <li class="sidebar-list-item">
            <span class="material-icons-outlined"> 3p </span>
            Feedaback
          </li>
        </a>

        <!-- <li class="sidebar-list-item">
          <span class="material-icons-outlined"> settings </span> Settings
        </li> -->
      </ul>

      <!-- Bottom Content -->
      <div class="bottom-content">
        <a href="../index.html" class="logout">
          <span class="material-icons-outlined">logout</span>Logout
        </a>
        <!-- <li class="mode">
          <div class="moon-sun">
            <span class="material-icons-outlined moon">dark_mode</span>
            <span class="material-icons-outlined sun">light_mode</span>
          </div>
          <span class="mode-text text">Dark Mode</span>
          <div class="toogle-switch">
            <span class="switch"></span>
          </div>
        </li> -->
      </div>
      <!-- End Bottom Content -->
    </aside>
    <!-- End Sidebar -->

    <script>
      // Function to extract user info from localStorage
      function getUserFromStorage() {
        try {
          const user = localStorage.getItem("user");
          return user ? JSON.parse(user) : null;
        } catch (e) {
          return null;
        }
      }

      // Helper: Parse JWT and extract email
      function getEmailFromJWT(token) {
        if (!token) return null;
        try {
          const payload = JSON.parse(atob(token.split('.')[1]));
          return payload.sub || payload.email || null;
        } catch (e) {
          return null;
        }
      }

      // Fetch user info using email from JWT and set header name (first and last only)
      async function setHeaderUserNameFromAPI() {
        const authToken = localStorage.getItem("authToken");
        const email = getEmailFromJWT(authToken);
        if (!email) return;

        try {
          const res = await fetch(`${BASE_API_URL}/user?email=${encodeURIComponent(email)}`, {
            headers: {
              Authorization: `Bearer ${authToken}`,
              "Content-Type": "application/json"
            }
          });
          if (res.ok) {
            const user = await res.json();
            // Only show first and last name
            let name = user.name || "";
            if (name) {
              const parts = name.trim().split(" ");
              name = parts[0] + (parts.length > 1 ? " " + parts[parts.length - 1] : "");
            }
            document.getElementById("userName").textContent = name || "User";
            // Set initials if no profile picture
            if (!user.profilePictureUrl) {
              document.getElementById("profileAvatar").textContent = (name ? (parts[0][0] + (parts.length > 1 ? parts[parts.length - 1][0] : "")) : "U").toUpperCase();
            } else {
              document.getElementById("profileAvatar").innerHTML = `<img src="${user.profilePictureUrl}" alt="Profile" style="width:38px;height:38px;border-radius:50%;">`;
            }
          }
        } catch (e) {
          // fallback: do nothing
        }
      }

      // Function to fetch and display parish name
      async function loadParishName() {
        try {
          const authToken = localStorage.getItem("authToken");
          const user = getUserFromStorage();
          if (!authToken || !user || !user.parishId) {
            document.getElementById("parish-name").textContent = "PARISH";
            return;
          }

          // Fetch parish data using the parish ID from user object
          const parishResponse = await fetch(
            `${BASE_API_URL}/parish/${user.parishId}`,
            {
              method: "GET",
              headers: {
                Authorization: `Bearer ${authToken}`,
                "Content-Type": "application/json",
              },
            }
          );

          if (parishResponse.ok) {
            const parish = await parishResponse.json();
            document.getElementById("parish-name").textContent =
              parish.name || "PARISH";
          } else {
            document.getElementById("parish-name").textContent = "PARISH";
          }
        } catch (error) {
          document.getElementById("parish-name").textContent = "PARISH";
        }
      }

      // Load parish name when page loads
      document.addEventListener("DOMContentLoaded", function () {
        loadParishName();
        setHeaderUserNameFromAPI();
      });

      // Existing logout functionality
      document.querySelectorAll(".logout").forEach((item) => {
        item.addEventListener("click", function (event) {
          event.preventDefault();
          localStorage.removeItem("authToken");
          localStorage.removeItem("user");
          window.location.href = this.getAttribute("href");
        });
      });

      // Helper to get initials from name
      function getInitials(name) {
        if (!name) return "";
        const parts = name.trim().split(" ");
        if (parts.length === 1) return parts[0][0].toUpperCase();
        return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
      }

      // Show user name and avatar/initials
      document.addEventListener("DOMContentLoaded", function () {
        const user = getUserFromStorage();
        const userNameSpan = document.getElementById("userName");
        const profileAvatar = document.getElementById("profileAvatar");

        if (user) {
          userNameSpan.textContent = user.name || "User";
          if (user.profilePictureUrl) {
            // If user has a profile picture, show it
            profileAvatar.innerHTML = `<img src="${user.profilePictureUrl}" alt="Profile" style="width:38px;height:38px;border-radius:50%;">`;
          } else {
            // Otherwise, show initials
            profileAvatar.textContent = getInitials(user.name || "U");
          }
        } else {
          userNameSpan.textContent = "User";
          profileAvatar.textContent = "U";
        }
      });
    </script>



  </body>
</html>
