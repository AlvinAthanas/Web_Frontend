<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>

    <!-- Montserrat Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap"
      rel="stylesheet"
    />

    <!-- Material Icons -->
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined"
      rel="stylesheet"
    />
  </head>
  <body>
    <!-- <div class="grid-container"> -->
    <!-- Header -->
    <header class="header">
      <div class="menu-icon" onclick="openSidebar()">
        <span class="material-icons-outlined"> menu </span>
      </div>
      <div class="header-left">
        <span class="material-icons-outlined"> search </span>
      </div>

      <div class="header-right">
        <span class="material-icons-outlined"> notifications </span>
        <span class="material-icons-outlined"> mail </span>
        <div class="account-container">
          <span class="material-icons-outlined"> account_circle </span>
          <div class="account-dropdown">
            <a href="../PROFILE/profile.html" class="dropdown-item">
              <span class="material-icons-outlined">person</span>
              Profile
            </a>
            <div class="dropdown-divider"></div>
            <a href="../index.html" class="dropdown-item">
              <span class="material-icons-outlined">logout</span>
              Logout
            </a>
          </div>
        </div>
      </div>
    </header>
    <!-- End Header -->

    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar">
      <div class="sidebar-title">
        <div class="sidebar-brand">
          <span class="material-icons-outlined"></span> <span id="parish-name">MENU</span>
        </div>
        <span class="material-icons-outlined" onclick="closeSidebar()"
          >close</span
        >
      </div>
      <ul class="sidebar-list">
        <a href="../DASHBOARD/dashboard.html">
          <li class="sidebar-list-item">
            <span class="material-icons-outlined">dashboard</span>
            Dashboard
          </li>
        </a>

        <a href="../ROLES/roles.html">
          <li class="sidebar-list-item">
            <span class="material-icons-outlined">assignment_ind</span> Roles
          </li>
        </a>

        <a href="../MEMBERS/members.html">
          <li class="sidebar-list-item">
            <span class="material-icons-outlined">people</span> Members
          </li>
        </a>

        <a href="../CONTRIBUTION/contribution.html">
          <li class="sidebar-list-item">
            <span class="material-icons-outlined"> payments </span>
            Contribution
          </li>
        </a>

        <a href="../SCHEDULES/Schedules.html">
          <li class="sidebar-list-item">
            <span class="material-icons-outlined">calendar_month</span>
            Schedule
          </li>
        </a>

        <a href="../EVENTS/Events.html">
          <li class="sidebar-list-item">
            <span class="material-icons-outlined"> event </span>
            Events
          </li>
        </a>

        <a href="../COMMUNITY/Community.html">
          <li class="sidebar-list-item">
            <span class="material-icons-outlined"> groups </span>
            Community
          </li>
        </a>

        <a href="../PROJECTS/projects.html">
          <li class="sidebar-list-item">
            <span class="material-icons-outlined"> rowing </span>
            Projects
          </li>
        </a>

        <a href="../SACRAMENTS/sacraments.html">
          <li class="sidebar-list-item">
            <span class="material-icons-outlined"> flare </span> Sacraments
          </li>
        </a>

        <a href="../REPORTS/reports.html">
          <li class="sidebar-list-item">
            <span class="material-icons-outlined"> library_books </span>
            Reports
          </li>
        </a>

        <!-- <li class="sidebar-list-item">
          <span class="material-icons-outlined"> settings </span> Settings
        </li> -->
      </ul>

      <!-- Bottom Content -->
      <div class="bottom-content">
        <a href="../index.html" class="logout">
          <span class="material-icons-outlined">logout</span>Logout
        </a>
        <!-- <li class="mode">
          <div class="moon-sun">
            <span class="material-icons-outlined moon">dark_mode</span>
            <span class="material-icons-outlined sun">light_mode</span>
          </div>
          <span class="mode-text text">Dark Mode</span>
          <div class="toogle-switch">
            <span class="switch"></span>
          </div>
        </li> -->
      </div>
      <!-- End Bottom Content -->
    </aside>
    <!-- End Sidebar -->

    <script>
      // Function to extract user email from JWT token
      function getUserEmailFromToken(token) {
        try {
          const payload = JSON.parse(atob(token.split('.')[1]));
          return payload.sub || payload.email; // 'sub' is common in JWT, adjust based on your token structure
        } catch (error) {
          console.error('Error parsing JWT token:', error);
          return null;
        }
      }

      // Function to fetch and display parish name
      async function loadParishName() {
        try {
          const authToken = localStorage.getItem('authToken');
          if (!authToken) {
            console.error('No auth token found');
            return;
          }

          // Extract user email from JWT token
          const userEmail = getUserEmailFromToken(authToken);
          if (!userEmail) {
            console.error('User email not found in token');
            return;
          }

          // First, get current user info to retrieve parish ID
          const userResponse = await fetch(`http://localhost:8080/user?email=${encodeURIComponent(userEmail)}`, {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${authToken}`,
              'Content-Type': 'application/json'
            }
          });

          if (!userResponse.ok) {
            console.error('Failed to fetch user data:', userResponse.status);
            return;
          }

          const userData = await userResponse.json();
          const parishId = userData.parishId;

          if (!parishId) {
            console.error('Parish ID not found in user data');
            return;
          }

          // Now fetch parish data using the parish ID
          const parishResponse = await fetch(`http://localhost:8080/parish/${parishId}`, {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${authToken}`,
              'Content-Type': 'application/json'
            }
          });

          if (parishResponse.ok) {
            const parish = await parishResponse.json();
            // Update the sidebar brand with parish name
            document.getElementById('parish-name').textContent = parish.name || 'PARISH';
          } else {
            console.error('Failed to fetch parish data:', parishResponse.status);
          }
        } catch (error) {
          console.error('Error loading parish name:', error);
        }
      }

      // Load parish name when page loads
      document.addEventListener('DOMContentLoaded', function() {
        loadParishName();
      });

      // Existing logout functionality
      document.querySelectorAll(".logout").forEach((item) => {
        item.addEventListener("click", function (event) {
          event.preventDefault();
          localStorage.removeItem("authToken"); // ✅ Remove JWT
          window.location.href = this.getAttribute("href"); // ✅ Redirect to login
        });
      });
    </script>
  </body>
</html>